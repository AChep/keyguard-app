name: "ðŸŽ‰ Release tag -> GitHub release"

on:
  push:
    tags:
      - 'r*'

jobs:
  build-macos-silicon-app:
    runs-on: macos-14
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: "Checkout"
        uses: actions/checkout@v6
        with:
          lfs: true
          submodules: recursive
      - uses: ./.github/actions/setup_gradle
        with:
          java-distribution: "liberica"
      - uses: ./.github/actions/build_desktop_licenses
      - name: "Decode signing certificate"
        run: |
          echo ${{ secrets.CERT_B64 }} | base64 -d | zcat > desktopApp/macos-dev.cer
      - name: "Import signing certificate"
        uses: apple-actions/import-codesign-certs@v6
        with:
          p12-filepath: desktopApp/macos-dev.cer
          p12-password: ${{ secrets.CERT_PASSWD }}
      - name: "Setup build env"
        run: |
          python .github/setup_gradle_properties_release.py tag=${{ github.ref_name }}
      - name: "Setup signing config"
        run: |
          echo "" >> gradle.properties
          echo "cert_identity=${{ secrets.CERT_IDENTITY }}" >> gradle.properties
      - name: "Setup notarization config"
        run: |
          echo "" >> gradle.properties
          echo "notarization_apple_id=${{ secrets.NOTARIZATION_APPLE_ID }}" >> gradle.properties
          echo "notarization_password=${{ secrets.NOTARIZATION_PASSWD }}" >> gradle.properties
          echo "notarization_asc_provider=${{ secrets.NOTARIZATION_ASC_PROVIDER }}" >> gradle.properties
      - name: "Build"
        run: ./gradlew :desktopApp:packageDmg :desktopApp:notarizeDmg -Dorg.gradle.configuration-cache.problems=warn
      - name: "Upload logs"
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: logs-mac-silicon
          path: desktopApp/build/compose/logs/**/*.txt
          retention-days: 30
      - name: "Upload binaries"
        uses: actions/upload-artifact@v6
        with:
          name: binaries-mac-silicon
          path: desktopApp/build/compose/binaries/main/**
          retention-days: 1
      - name: "Add a suffix to the artifacts"
        run: |
          cd desktopApp/build/compose/binaries/main/dmg
          for f in * ; do mv -- "$f" "$(echo $f | sed -nE 's/^(.*)(\..*)$/\1-apple\2/p')" ; done
      - name: "Upload .dmg"
        uses: actions/upload-artifact@v6
        with:
          name: app-mac-silicon
          path: desktopApp/build/compose/binaries/main/dmg/*.dmg
          retention-days: 1
  build-macos-intel-app:
    runs-on: macos-13
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: "Checkout"
        uses: actions/checkout@v6
        with:
          lfs: true
          submodules: recursive
      - uses: ./.github/actions/setup_gradle
      - uses: ./.github/actions/build_desktop_licenses
      - name: "Decode signing certificate"
        run: |
          echo ${{ secrets.CERT_B64 }} | base64 -d | zcat > desktopApp/macos-dev.cer
      - name: "Import signing certificate"
        uses: apple-actions/import-codesign-certs@v6
        with:
          p12-filepath: desktopApp/macos-dev.cer
          p12-password: ${{ secrets.CERT_PASSWD }}
      - name: "Setup build env"
        run: |
          python .github/setup_gradle_properties_release.py tag=${{ github.ref_name }}
      - name: "Setup signing config"
        run: |
          echo "" >> gradle.properties
          echo "cert_identity=${{ secrets.CERT_IDENTITY }}" >> gradle.properties
      - name: "Setup notarization config"
        run: |
          echo "" >> gradle.properties
          echo "notarization_apple_id=${{ secrets.NOTARIZATION_APPLE_ID }}" >> gradle.properties
          echo "notarization_password=${{ secrets.NOTARIZATION_PASSWD }}" >> gradle.properties
          echo "notarization_asc_provider=${{ secrets.NOTARIZATION_ASC_PROVIDER }}" >> gradle.properties
      - name: "Build"
        run: ./gradlew :desktopApp:packageDmg :desktopApp:notarizeDmg -Dorg.gradle.configuration-cache.problems=warn
      - name: 'Upload logs'
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: logs-mac-intel
          path: desktopApp/build/compose/logs/**/*.txt
          retention-days: 30
      - name: 'Upload binaries'
        uses: actions/upload-artifact@v6
        with:
          name: binaries-mac-intel
          path: desktopApp/build/compose/binaries/main/**
          retention-days: 1
      - name: "Add a suffix to the artifacts"
        run: |
          cd desktopApp/build/compose/binaries/main/dmg
          for f in * ; do mv -- "$f" "$(echo $f | sed -nE 's/^(.*)(\..*)$/\1-intel\2/p')" ; done
      - name: 'Upload .dmg'
        uses: actions/upload-artifact@v6
        with:
          name: app-mac-intel
          path: desktopApp/build/compose/binaries/main/dmg/*.dmg
          retention-days: 1
  build-linux-flatpak-app:
    runs-on: ubuntu-latest
    container:
      image: bilelmoussaoui/flatpak-github-actions:gnome-47
      options: --privileged
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: "Checkout"
        uses: actions/checkout@v6
        with:
          lfs: true
          submodules: recursive
      - uses: ./.github/actions/setup_gradle
      - uses: ./.github/actions/setup_python
      - uses: ./.github/actions/build_desktop_licenses
      - name: "Setup build env"
        run: |
          pwd
          git config --global --add safe.directory "$(pwd)"
          python .github/setup_gradle_properties_release.py tag=${{ github.ref_name }}
      - name: "Build"
        run: ./gradlew :desktopApp:bundleFlatpak -Dorg.gradle.configuration-cache.problems=warn
      - name: 'Upload .flatpak'
        uses: actions/upload-artifact@v6
        with:
          name: app-linux-flatpak
          path: desktopApp/build/flatpak/Keyguard.flatpak
          retention-days: 1
  build-windows-app:
    runs-on: windows-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: "Checkout"
        uses: actions/checkout@v6
        with:
          lfs: true
          submodules: recursive
      - uses: ./.github/actions/setup_gradle
        with:
          java-version: |
            11
            21
      - uses: ./.github/actions/build_desktop_licenses
      - name: "Setup build env"
        run: |
          python .github/setup_gradle_properties_release.py tag=${{ github.ref_name }}
      - name: "Build"
        run: ./gradlew :desktopApp:packageMsi -Dorg.gradle.configuration-cache.problems=warn
      - name: 'Upload .msi'
        uses: actions/upload-artifact@v6
        with:
          name: app-windows
          path: desktopApp/build/compose/binaries/main/msi/*.msi
          retention-days: 1
  build-android-app:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: "Checkout"
        uses: actions/checkout@v6
        with:
          lfs: true
          submodules: recursive
      - uses: ./.github/actions/setup_gradle
      - name: "Prepare env"
        run: |
          echo ${{ secrets.KEYSTORE_B64 }} | base64 -d | zcat >> androidApp/keyguard-release.keystore
          echo ${{ secrets.KEYSTORE_PROPS_B64 }} | base64 -d | zcat >> androidApp/keyguard-release.properties
          echo ${{ secrets.GOOGLE_SERVICES }} | base64 -d | zcat >> androidApp/google-services.json
          python .github/setup_gradle_properties_release.py tag=${{ github.ref_name }}
      - uses: ./.github/actions/build_android_licenses
        with:
          build-flavor: "None"
      - uses: ./.github/actions/build_android_baseline_profiles
        with:
          build-flavor: "None"
      - name: "Build"
        run: ./gradlew androidApp:assembleNoneRelease
      - name: 'Upload .apk'
        uses: actions/upload-artifact@v6
        with:
          name: app-android
          path: |
            androidApp/build/outputs/apk/**/*.apk
            androidApp/build/outputs/mapping/**/mapping.txt
          retention-days: 1
  dist:
    runs-on: ubuntu-latest
    needs:
      - build-android-app
      - build-linux-flatpak-app
      - build-macos-silicon-app
      - build-macos-intel-app
      - build-windows-app
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: "Checkout"
        uses: actions/checkout@v6
        with:
          submodules: recursive
      - name: "Generate changelog"
        id: changelog
        uses: metcalfc/changelog-generator@v4.6.2
        with:
          myToken: ${{ secrets.GITHUB_TOKEN }}
      - name: "Download Mac app (Intel)"
        uses: actions/download-artifact@v7
        with:
          name: app-mac-intel
          path: artifacts
      - name: "Download Mac app (Apple Silicon)"
        uses: actions/download-artifact@v7
        with:
          name: app-mac-silicon
          path: artifacts
      - name: "Download Linux app"
        uses: actions/download-artifact@v7
        with:
          name: app-linux-flatpak
          path: artifacts
      - name: "Download Windows app"
        uses: actions/download-artifact@v7
        with:
          name: app-windows
          path: artifacts
      - name: "Download Android app"
        uses: actions/download-artifact@v7
        with:
          name: app-android
          path: artifacts
      - id: vars
        run: |
          release_name=$(python .github/get_release_name.py tag=${{ github.ref_name }})
          echo "release_name=$release_name" >> $GITHUB_OUTPUT
      - name: "Create release"
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: Release ${{ steps.vars.outputs.release_name }}
          body: ${{ steps.changelog.outputs.changelog }}
          token: ${{ secrets.PERSONAL_TOKEN }}
          files: |
            artifacts/*
            artifacts/**/*.apk
  deploy:
    name: Deploy ${{ matrix.wf-file }}
    runs-on: ubuntu-slim
    needs:
      - dist
    strategy:
      fail-fast: false
      matrix:
        wf-file:
          - new_release_deploy_fdroid.yml
          - new_release_deploy_homebrew.yml
    steps:
      - name: "Checkout"
        uses: actions/checkout@v6
      - name: "Trigger Workflow"
        uses: ./.github/actions/github_trigger_wf
        with:
          github-token: ${{ secrets.PERSONAL_TOKEN }}
          github-wf-file: ${{ matrix.wf-file }}
