name: "ðŸŽ‰ Release tag -> GitHub release"

on:
  push:
    tags:
      - 'r*'

jobs:
  build-macos-app:
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15
            arch: apple
          - runner: macos-15-intel
            arch: intel
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: "Checkout"
        uses: actions/checkout@v6
        with:
          lfs: true
          submodules: recursive
      - uses: ./.github/actions/setup_gradle
        with:
          java-distribution: "liberica"
      - uses: ./.github/actions/build_desktop_licenses
      - name: "Decode signing certificate"
        run: |
          echo ${{ secrets.CERT_B64 }} | base64 -d | zcat > desktopApp/macos-dev.cer
      - name: "Import signing certificate"
        uses: apple-actions/import-codesign-certs@v6
        with:
          p12-filepath: desktopApp/macos-dev.cer
          p12-password: ${{ secrets.CERT_PASSWD }}
      - name: "Setup build env"
        run: |
          python .github/setup_gradle_properties_release.py tag=${{ github.ref_name }}
      - name: "Setup signing config"
        run: |
          echo "" >> gradle.properties
          echo "cert_identity=${{ secrets.CERT_IDENTITY }}" >> gradle.properties
      - name: "Setup notarization config"
        run: |
          echo "" >> gradle.properties
          echo "notarization_apple_id=${{ secrets.NOTARIZATION_APPLE_ID }}" >> gradle.properties
          echo "notarization_password=${{ secrets.NOTARIZATION_PASSWD }}" >> gradle.properties
          echo "notarization_asc_provider=${{ secrets.NOTARIZATION_ASC_PROVIDER }}" >> gradle.properties
      - name: "Build"
        run: ./gradlew :desktopApp:packageReleaseDmg :desktopApp:notarizeReleaseDmg
      - name: "Upload logs"
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: logs-mac-${{ matrix.arch }}
          path: desktopApp/build/compose/logs/**/*.txt
          retention-days: 30
      - name: "Upload binaries"
        uses: actions/upload-artifact@v6
        with:
          name: binaries-mac-${{ matrix.arch }}
          path: desktopApp/build/compose/binaries/main-release/**
          retention-days: 1
      - name: "Add a suffix to the artifacts"
        run: |
          cd desktopApp/build/compose/binaries/main-release/dmg
          for f in * ; do mv -- "$f" "$(echo $f | sed -nE 's/^(.*)(\..*)$/\1-${{ matrix.arch }}\2/p')" ; done
      - name: "Upload .dmg"
        uses: actions/upload-artifact@v6
        with:
          name: app-mac-${{ matrix.arch }}
          path: desktopApp/build/compose/binaries/main-release/dmg/*.dmg
          retention-days: 1
  # This step can be skipped once the Kotlin Native compiler
  # gains an ability to be run on a Linux ARM64 host:
  # https://kotlinlang.org/docs/native-target-support.html#hosts
  #
  # After that is done you should be able to just run
  # ./gradlew :desktopApp:packageDistributable
  build-linux-lib-native:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v6
        with:
          lfs: true
          submodules: recursive
      - uses: ./.github/actions/setup_gradle
      - name: "Build"
        run: ./gradlew :desktopLibNative:linkReleaseSharedLinuxX64 :desktopLibNative:linkReleaseSharedLinuxArm64
      - name: 'Upload .so (x86_64)'
        uses: actions/upload-artifact@v6
        with:
          name: app-linux-lib-native-x86_64
          path: |
            desktopLibNative/build/bin/linuxX64/releaseShared/libkeyguard.so
      - name: 'Upload .so (aarch64)'
        uses: actions/upload-artifact@v6
        with:
          name: app-linux-lib-native-aarch64
          path: |
            desktopLibNative/build/bin/linuxArm64/releaseShared/libkeyguard.so
  build-linux-app:
    runs-on: ${{ matrix.runner }}
    needs:
      - build-linux-lib-native
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            arch: x86_64
          - runner: ubuntu-24.04-arm
            arch: aarch64
    steps:
      - name: "Checkout"
        uses: actions/checkout@v6
        with:
          lfs: true
          submodules: recursive
      - uses: ./.github/actions/setup_gradle
      - name: "Download lib native"
        uses: actions/download-artifact@v7
        with:
          name: app-linux-lib-native-${{ matrix.arch }}
          path: libnative-${{ matrix.arch }}
      - name: "Move binaries into the libnative directory"
        run: |
          install -D libnative-${{ matrix.arch }}/libkeyguard.so desktopLibNative/build/bin/universal/libkeyguard
      - name: "Setup build env"
        run: |
          pwd
          git config --global --add safe.directory "$(pwd)"
          python .github/setup_gradle_properties_release.py tag=${{ github.ref_name }}
      - uses: ./.github/actions/build_desktop_licenses
      - name: "Build"
        run: ./gradlew :desktopApp:packageReleaseDistributable -x :desktopLibNative:linkReleaseSharedUniversal
      - name: 'Upload .tar'
        uses: actions/upload-artifact@v6
        with:
          name: app-linux-${{ matrix.arch }}
          path: |
            desktopApp/build/distributions/*.tar.gz
      - name: "Move binaries into the template directory"
        run: |
          mkdir -p desktopApp/flatpak/app-${{ matrix.arch }}/
          tar -xvzf $(find . -type f -regex '\./desktopApp/build/distributions/.*\.tar.gz') -C desktopApp/flatpak/app-${{ matrix.arch }}/ --strip-components=1
      - name: "Get Flatpak runtime version -install dependencies"
        run: pip install -r .github/get_flatpak_runtime_version.requirements.txt
      - name: "Get Flatpak runtime version"
        id: get-flatpak-runtime-version
        run: echo "version=$(python .github/get_flatpak_runtime_version.py desktopApp/flatpak/com.artemchep.keyguard.yml)" >> $GITHUB_OUTPUT
      - name: "Setup Flatpak"
        run: |
          sudo apt-get update
          sudo apt install flatpak flatpak-builder
          flatpak remote-add --if-not-exists --user flathub https://dl.flathub.org/repo/flathub.flatpakrepo
          flatpak install flathub org.gnome.Platform//${{ steps.get-flatpak-runtime-version.outputs.version }} org.gnome.Sdk//${{ steps.get-flatpak-runtime-version.outputs.version }} -y
      - name: "Build"
        working-directory: desktopApp/flatpak/
        run: |
          flatpak-builder --force-clean --state-dir=build/flatpak-builder --repo=build/flatpak-repo build/flatpak-target com.artemchep.keyguard.yml
          flatpak build-bundle build/flatpak-repo "Keyguard-$(find ../build/distributions -type f -name '*.tar.gz' | sed -E 's/.*-([0-9]+\.[0-9]+\.[0-9]+)-.*/\1/')-${{ matrix.arch }}.flatpak" com.artemchep.keyguard
      - name: 'Upload .flatpak'
        uses: actions/upload-artifact@v6
        with:
          name: app-linux-flatpak-${{ matrix.arch }}
          path: |
            desktopApp/flatpak/Keyguard-*.flatpak
  build-windows-app:
    runs-on: windows-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: "Checkout"
        uses: actions/checkout@v6
        with:
          lfs: true
          submodules: recursive
      - uses: ./.github/actions/setup_gradle
        with:
          java-version: |
            11
            21
      - uses: ./.github/actions/build_desktop_licenses
      - name: "Setup build env"
        run: |
          python .github/setup_gradle_properties_release.py tag=${{ github.ref_name }}
      - name: "Build"
        run: ./gradlew :desktopApp:packageReleaseMsi
      - name: 'Upload .msi'
        uses: actions/upload-artifact@v6
        with:
          name: app-windows
          path: desktopApp/build/compose/binaries/main-release/msi/*.msi
          retention-days: 1
  build-android-app:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: "Checkout"
        uses: actions/checkout@v6
        with:
          lfs: true
          submodules: recursive
      - uses: ./.github/actions/setup_gradle
      - name: "Prepare env"
        run: |
          echo ${{ secrets.KEYSTORE_B64 }} | base64 -d | zcat >> androidApp/keyguard-release.keystore
          echo ${{ secrets.KEYSTORE_PROPS_B64 }} | base64 -d | zcat >> androidApp/keyguard-release.properties
          echo ${{ secrets.GOOGLE_SERVICES }} | base64 -d | zcat >> androidApp/google-services.json
          python .github/setup_gradle_properties_release.py tag=${{ github.ref_name }}
      - uses: ./.github/actions/build_android_licenses
        with:
          build-flavor: "None"
      - uses: ./.github/actions/build_android_baseline_profiles
        with:
          build-flavor: "None"
      - name: "Build"
        run: ./gradlew androidApp:assembleNoneRelease
      - name: 'Upload .apk'
        uses: actions/upload-artifact@v6
        with:
          name: app-android
          path: |
            androidApp/build/outputs/apk/**/*.apk
            androidApp/build/outputs/mapping/**/mapping.txt
          retention-days: 1
  dist:
    runs-on: ubuntu-latest
    needs:
      - build-android-app
      - build-linux-app
      - build-macos-app
      - build-windows-app
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: "Checkout"
        uses: actions/checkout@v6
        with:
          submodules: recursive
      - name: "Generate changelog"
        id: changelog
        uses: metcalfc/changelog-generator@v4.6.2
        with:
          myToken: ${{ secrets.GITHUB_TOKEN }}
      - name: "Download Mac app (Intel)"
        uses: actions/download-artifact@v7
        with:
          name: app-mac-intel
          path: artifacts
      - name: "Download Mac app (Apple Silicon)"
        uses: actions/download-artifact@v7
        with:
          name: app-mac-apple
          path: artifacts
      - name: "Download Linux app (x86_64)"
        uses: actions/download-artifact@v7
        with:
          name: app-linux-x86_64
          path: artifacts
      - name: "Download Linux app (aarch64)"
        uses: actions/download-artifact@v7
        with:
          name: app-linux-aarch64
          path: artifacts
      - name: "Download Linux app (flatpak-x86_64)"
        uses: actions/download-artifact@v7
        with:
          name: app-linux-flatpak-x86_64
          path: artifacts
      - name: "Download Linux app (flatpak-aarch64)"
        uses: actions/download-artifact@v7
        with:
          name: app-linux-flatpak-aarch64
          path: artifacts
      - name: "Download Windows app"
        uses: actions/download-artifact@v7
        with:
          name: app-windows
          path: artifacts
      - name: "Download Android app"
        uses: actions/download-artifact@v7
        with:
          name: app-android
          path: artifacts
      - id: vars
        run: |
          release_name=$(python .github/get_release_name.py tag=${{ github.ref_name }})
          echo "release_name=$release_name" >> $GITHUB_OUTPUT
      - name: "Create release"
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: Release ${{ steps.vars.outputs.release_name }}
          body: ${{ steps.changelog.outputs.changelog }}
          token: ${{ secrets.PERSONAL_TOKEN }}
          files: |
            artifacts/*
            artifacts/**/*.apk
  deploy:
    name: Deploy ${{ matrix.wf-file }}
    runs-on: ubuntu-slim
    needs:
      - dist
    strategy:
      fail-fast: false
      matrix:
        wf-file:
          - new_release_deploy_fdroid.yml
          - new_release_deploy_homebrew.yml
          - new_release_deploy_scoop.yml
    steps:
      - name: "Checkout"
        uses: actions/checkout@v6
      - name: "Trigger Workflow"
        uses: ./.github/actions/github_trigger_wf
        with:
          github-token: ${{ secrets.PERSONAL_TOKEN }}
          github-wf-file: ${{ matrix.wf-file }}
